# Trademe 开发环境调试流程记录

**记录时间**: 2025-08-21  
**版本**: v1.0  
**环境**: Ubuntu 22.04, Node.js 20+, Python 3.12+

## 🚀 快速启动命令

### 一键启动开发环境
```bash
cd /root/trademe
chmod +x start-dev.sh stop-dev.sh
./start-dev.sh
```

### 一键停止开发环境
```bash
./stop-dev.sh
```

## 📋 服务访问地址

| 服务 | 地址 | 端口 | 说明 |
|-----|------|------|------|
| 前端界面 | http://localhost:3000 | 3000 | React + Vite 开发服务器 |
| 用户服务 | http://localhost:3001 | 3001 | Node.js + Express API |
| 交易服务 | http://localhost:8001 | 8001 | Python + FastAPI API |

## 🔧 手动启动流程 (调试用)

### 1. 启动交易服务 (Python FastAPI)
```bash
cd /root/trademe/backend/trading-service
PYTHONPATH=/root/trademe/backend/trading-service uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
```
**预期结果**: `INFO: Uvicorn running on http://0.0.0.0:8001`

### 2. 启动用户服务 (Node.js)
```bash
cd /root/trademe/backend/user-service
npm run dev
```
**预期结果**: `🚀 User Service started successfully!`

### 3. 启动前端服务 (React + Vite)
```bash
cd /root/trademe/frontend
npm run dev
```
**预期结果**: `VITE v5.4.19 ready in XXXms`

## 🛠 常见问题解决方案

### 1. 端口占用问题
**症状**: `Address already in use`

**解决方案**:
```bash
# 查看端口占用
lsof -i:3000
lsof -i:3001
lsof -i:8001

# 清理端口占用
lsof -ti:3000 | xargs kill -9
lsof -ti:3001 | xargs kill -9
lsof -ti:8001 | xargs kill -9

# 或使用强制清理
pkill -f "vite\|uvicorn\|ts-node\|nodemon"
```

### 2. 前端热更新不生效
**症状**: 修改代码后页面不自动刷新

**解决方案**:
1. **重启Vite服务**:
   ```bash
   cd /root/trademe/frontend
   pkill -f "vite.*3000"
   npm run dev
   ```

2. **清除浏览器缓存**: 
   - 按 `Ctrl+F5` (硬刷新)
   - 或 `F12` → 右键刷新按钮 → "清空缓存并硬性重新加载"

3. **检查文件监听**:
   ```bash
   # 确认Vite正在监听文件变化
   cat /proc/sys/fs/inotify/max_user_watches
   # 如果值太小，增加限制:
   echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
   sudo sysctl -p
   ```

### 3. 数据库连接问题
**症状**: `Database connection failed`

**解决方案**:
```bash
# 检查SQLite数据库文件
ls -la /root/trademe/data/trademe.db

# 检查权限
chmod 644 /root/trademe/data/trademe.db

# 重新初始化数据库 (如果需要)
cd /root/trademe/backend/user-service
npm run db:migrate
```

### 4. Python模块导入问题
**症状**: `ModuleNotFoundError: No module named 'app'`

**解决方案**:
```bash
# 确保PYTHONPATH设置正确
cd /root/trademe/backend/trading-service
export PYTHONPATH=/root/trademe/backend/trading-service
python -c "import app.main; print('Import successful')"

# 或直接使用完整路径启动
PYTHONPATH=/root/trademe/backend/trading-service uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
```

### 5. Redis连接问题
**症状**: `Redis connection failed`

**解决方案**:
```bash
# 检查Redis服务状态
systemctl status redis
sudo systemctl start redis

# 测试Redis连接
redis-cli ping
```

## 🔍 服务健康检查

### 检查所有服务状态
```bash
# 交易服务健康检查
curl http://localhost:8001/health

# 用户服务健康检查  
curl http://localhost:3001/health

# 前端服务检查
curl -I http://localhost:3000
```

### 预期响应
```json
// 交易服务 (8001)
{
  "status": "healthy",
  "timestamp": 1755771910.4083562,
  "environment": "development"
}

// 用户服务 (3001)
{
  "status": "ok",
  "timestamp": "2025-08-21T10:25:10.272Z",
  "uptime": 47.276356207,
  "services": {
    "database": "healthy",
    "redis": "healthy",
    "upload": "healthy",
    "email": "healthy"
  },
  "version": "1.0.0",
  "environment": "development"
}

// 前端服务 (3000)
HTTP/1.1 200 OK
```

## 📁 日志文件位置

| 服务 | 日志文件路径 |
|-----|-------------|
| 交易服务 | `/root/trademe/logs/trading-service.log` |
| 用户服务 | `/root/trademe/logs/user-service.log` |
| 前端服务 | `/root/trademe/logs/frontend.log` |

### 查看实时日志
```bash
# 查看交易服务日志
tail -f /root/trademe/logs/trading-service.log

# 查看用户服务日志
tail -f /root/trademe/logs/user-service.log

# 查看前端服务日志
tail -f /root/trademe/logs/frontend.log
```

## 🔄 开发工作流程

### 1. 每日启动流程
```bash
cd /root/trademe
./start-dev.sh
# 等待所有服务启动完成
# 访问 http://localhost:3000 开始开发
```

### 2. 代码修改热更新
- **前端修改**: 自动热更新，立即生效
- **用户服务修改**: nodemon自动重启
- **交易服务修改**: uvicorn自动重启

### 3. 调试过程
1. **查看实时日志**: `tail -f logs/*.log`
2. **检查服务状态**: 访问健康检查端点
3. **重启特定服务**: 停止进程后重新启动
4. **清理缓存**: 浏览器硬刷新或清除缓存

### 4. 结束开发
```bash
./stop-dev.sh
# 确认所有服务已停止
```

## 🚨 紧急问题处理

### 系统完全重启
```bash
# 1. 停止所有服务
./stop-dev.sh

# 2. 清理所有相关进程
pkill -f "node\|python\|vite\|uvicorn"

# 3. 清理端口占用
for port in 3000 3001 8001; do
    lsof -ti:$port | xargs -r kill -9
done

# 4. 重新启动
./start-dev.sh
```

### 数据库重置 (谨慎操作)
```bash
# 备份现有数据
cp /root/trademe/data/trademe.db /root/trademe/data/trademe.db.backup

# 重新初始化数据库
cd /root/trademe/backend/user-service
npm run db:reset
npm run db:migrate
```

## 📊 性能监控

### 资源使用监控
```bash
# 查看进程资源占用
ps aux | grep -E "(node|python|vite|uvicorn)"

# 查看端口监听状态
netstat -tlnp | grep -E "(3000|3001|8001)"

# 查看系统资源
htop
```

### 日志大小监控
```bash
# 检查日志文件大小
du -sh /root/trademe/logs/*

# 清理大日志文件 (如果需要)
truncate -s 0 /root/trademe/logs/*.log
```

## 💡 最佳实践

1. **每天开发前**: 运行 `./start-dev.sh` 确保环境正常
2. **代码提交前**: 确保所有服务正常运行和健康检查通过
3. **遇到问题**: 先查看相应服务的日志文件
4. **结束开发**: 运行 `./stop-dev.sh` 释放系统资源
5. **定期维护**: 清理日志文件，检查数据库大小

---

**维护者**: Trademe开发团队  
**最后更新**: 2025-08-21  
**版本**: v1.0