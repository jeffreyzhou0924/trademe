# Trademe 开发环境配置记录

**记录时间**: 2025-08-21 19:24  
**环境状态**: 生产就绪，支持公网热更新调试  
**公网地址**: http://43.167.252.120

## 🌍 系统概览

### 服务器信息
- **公网IP**: 43.167.252.120 (腾讯云)
- **配置**: 4核8GB，Ubuntu 22.04
- **项目路径**: `/root/trademe`
- **Nginx配置**: `/etc/nginx/sites-available/trademe.one`

### 三层服务架构
```
🌐 公网访问 (43.167.252.120:80)
    ↓ Nginx反向代理
    ├── 前端服务 (127.0.0.1:3000) ← Vite开发服务器 + HMR
    ├── 用户服务 (127.0.0.1:3001) ← Node.js + Express
    └── 交易服务 (127.0.0.1:8001) ← Python + FastAPI
```

## 🔧 详细配置

### 1. 前端服务 (React + Vite)
**端口**: 3000  
**进程**: npm run dev  
**特性**: 热模块替换 (HMR) + React Fast Refresh

**关键配置** (`vite.config.ts`):
```typescript
export default defineConfig({
  server: {
    port: 3000,
    host: '0.0.0.0'  // 确保IPv4绑定，支持Nginx代理
  }
})
```

**热更新机制**:
- Vite监听文件变化
- WebSocket连接实现实时通信
- 通过Nginx代理支持公网热更新访问

### 2. 用户服务 (Node.js + Express)
**端口**: 3001  
**进程**: nodemon + ts-node  
**数据库**: SQLite + Prisma ORM  
**功能**: 用户认证、JWT管理、会员系统

**健康检查端点**: http://localhost:3001/health
```json
{
  "status": "ok",
  "services": {
    "database": "healthy",
    "redis": "healthy", 
    "upload": "healthy",
    "email": "healthy"
  }
}
```

### 3. 交易服务 (Python + FastAPI)
**端口**: 8001  
**进程**: uvicorn --reload  
**功能**: 策略管理、回测引擎、AI对话

**启动参数**:
```bash
PYTHONPATH=/root/trademe/backend/trading-service \
uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
```

**健康检查端点**: http://localhost:8001/health
```json
{
  "status": "healthy",
  "timestamp": 1755775437.24,
  "environment": "development"
}
```

### 4. Nginx反向代理配置
**配置文件**: `/etc/nginx/sites-available/trademe.one`

**关键配置段**:
```nginx
# 前端开发服务器代理 (支持热更新)
upstream frontend {
    server 127.0.0.1:3000;
}

# 用户服务API代理  
upstream user_service {
    server 127.0.0.1:3001;
}

# 交易服务API代理
upstream trading_service {
    server 127.0.0.1:8001;
}

server {
    listen 80;
    server_name 43.167.252.120;

    # 前端应用 (支持WebSocket热更新)
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    # 用户服务API
    location /api/v1/ {
        proxy_pass http://user_service/api/v1/;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
    }

    # 交易服务API
    location /trading/api/v1/ {
        proxy_pass http://trading_service/api/v1/;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
    }

    # 健康检查
    location /health {
        return 200 'healthy';
        add_header Content-Type text/plain;
    }
}
```

## 🚀 启动流程

### 自动化启动脚本
**文件**: `/root/trademe/start-dev.sh`

**执行步骤**:
1. 清理端口占用 (3000, 3001, 8001)
2. 验证Nginx配置
3. 启动交易服务 (Python FastAPI)
4. 启动用户服务 (Node.js Express)  
5. 启动前端服务 (React Vite + HMR)
6. 重新加载Nginx配置
7. 验证所有服务健康状态
8. 测试公网访问和热更新功能

**使用方法**:
```bash
cd /root/trademe
chmod +x start-dev.sh
./start-dev.sh
```

### 停止脚本
**文件**: `/root/trademe/stop-dev.sh`
```bash
cd /root/trademe
./stop-dev.sh
```

## 🔥 热更新调试功能

### 前端热更新
- **文件监听**: Vite监听 `src/` 目录
- **即时更新**: 修改React组件立即生效
- **状态保持**: 组件状态在更新中保持
- **错误显示**: 语法错误在浏览器中显示

### 后端自动重启
- **用户服务**: nodemon监听TypeScript文件变化
- **交易服务**: uvicorn监听Python文件变化
- **重启时间**: ~2-3秒

### 公网访问验证
✅ **前端界面**: http://43.167.252.120  
✅ **用户API**: http://43.167.252.120/api/v1  
✅ **交易API**: http://43.167.252.120/trading/api/v1  
✅ **健康检查**: http://43.167.252.120/health

## 📊 服务监控

### 实时日志查看
```bash
# 查看所有服务日志
tail -f /root/trademe/logs/*.log

# 分别查看各服务日志
tail -f /root/trademe/logs/frontend.log
tail -f /root/trademe/logs/user-service.log  
tail -f /root/trademe/logs/trading-service.log
```

### 进程状态检查
```bash
# 检查运行中的服务
ps aux | grep -E "(node|uvicorn|nginx)" | grep -v grep

# 检查端口占用
lsof -i:3000,3001,8001

# 检查Nginx状态
systemctl status nginx
```

### 防火墙配置
```bash
# 查看防火墙状态
ufw status

# 开放必要端口
ufw allow 80
ufw allow 3000
ufw allow 3001  
ufw allow 8001
```

## 🧪 测试环境

### 测试账户
- **邮箱**: publictest@example.com
- **密码**: PublicTest123!
- **权限**: 高级版 (premium)
- **到期时间**: 2026-08-21

### API测试示例
```bash
# 用户登录
curl -X POST "http://43.167.252.120/api/v1/auth/login" \
-H "Content-Type: application/json" \
-d '{"email":"publictest@example.com","password":"PublicTest123!"}'

# 健康检查
curl http://43.167.252.120/health
curl http://43.167.252.120/api/v1/health  
curl http://43.167.252.120/trading/api/v1/health
```

## 🔧 问题排除

### 常见问题
1. **热更新不生效**
   - 检查Vite配置 `host: '0.0.0.0'`
   - 验证Nginx代理配置
   - 确认WebSocket连接正常

2. **服务启动失败**
   - 检查端口占用: `lsof -i:3000,3001,8001`
   - 查看错误日志: `tail -20 /root/trademe/logs/*.log`
   - 验证依赖安装: `npm install` / `pip install`

3. **公网访问失败**
   - 检查防火墙: `ufw status`
   - 验证Nginx配置: `nginx -t`
   - 重启Nginx: `systemctl restart nginx`

### 服务重启
```bash
# 重启单个服务
systemctl restart nginx

# 重启整个环境
./stop-dev.sh && ./start-dev.sh
```

## 📝 开发工作流

### 前端开发
1. 修改 `/root/trademe/frontend/src/` 中的文件
2. 保存后自动触发热更新
3. 在 http://43.167.252.120 中实时查看效果

### 后端开发  
1. 修改用户服务: `/root/trademe/backend/user-service/src/`
2. 修改交易服务: `/root/trademe/backend/trading-service/app/`
3. 保存后服务自动重启 (2-3秒)

### 调试技巧
- **前端调试**: Chrome DevTools + React DevTools
- **后端调试**: VS Code断点 + 日志输出
- **网络调试**: Nginx日志 + 浏览器Network面板
- **数据库调试**: SQLite Browser + Prisma Studio

---

**维护说明**: 此配置经过完整测试，支持远程开发和公网调试。下次启动开发环境时，直接执行 `./start-dev.sh` 即可获得相同的配置环境。