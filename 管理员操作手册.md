# Trademe 平台管理员操作手册

## 🔐 管理员登录

### 管理员账号信息
- **邮箱**: `admin@trademe.com`
- **当前密码**: `admin123456`
- **权限**: 系统管理员 (ADMIN_EMAIL配置)

#### 🔒 密码历史记录
- `password123` - 2025-08-21 (初始开发阶段)
- `Admin123!` - 2025-08-22 (create_admin.js脚本设置)
- `admin123456` - 2025-08-24 (当前使用，bcrypt加密存储)

### 登录步骤
1. 访问 `http://43.167.252.120/login`
2. 输入管理员邮箱和密码
3. 登录成功后，导航栏会显示"管理面板"入口

---

## 🛠 管理面板功能

### 1. 用户管理
**路径**: `/admin/users`

#### 用户列表查看
- 显示所有注册用户
- 用户基本信息 (ID, 用户名, 邮箱, 注册时间)
- 用户状态 (激活/禁用)
- 会员等级 (BASIC/PREMIUM)

#### 用户操作
- **查看详情**: 点击用户查看详细信息
- **禁用用户**: 临时禁止用户登录
- **激活用户**: 重新激活被禁用的用户
- **升级会员**: 调整用户会员等级

### 2. 系统监控
**路径**: `/admin/system`

#### 服务状态监控
```bash
# 检查服务运行状态
sudo systemctl status nginx
sudo systemctl status redis
ps aux | grep "node.*user-service"
ps aux | grep "uvicorn.*trading-service"
```

#### 系统资源监控
- **CPU使用率**: `top` 或 `htop`
- **内存使用**: `free -h`
- **磁盘空间**: `df -h`
- **网络连接**: `netstat -tlnp`

#### 日志查看
```bash
# 用户服务日志
tail -f /root/trademe/backend/user-service/logs/combined.log

# Nginx访问日志  
tail -f /var/log/nginx/trademe_access.log

# Nginx错误日志
tail -f /var/log/nginx/trademe_error.log

# 交易服务日志 (后台进程)
# 查看FastAPI服务输出
```

### 3. 数据库管理

#### 用户数据查询
```sql
-- 查看所有用户
SELECT id, username, email, membership_level, created_at 
FROM users ORDER BY created_at DESC;

-- 查看用户登录统计
SELECT email, last_login_at, created_at 
FROM users WHERE last_login_at IS NOT NULL;

-- 查看会员分布
SELECT membership_level, COUNT(*) as count 
FROM users GROUP BY membership_level;
```

#### 交易数据统计
```sql
-- 查看策略统计
SELECT COUNT(*) as total_strategies FROM strategies;

-- 查看回测统计
SELECT status, COUNT(*) as count 
FROM backtests GROUP BY status;

-- 查看交易记录统计
SELECT trade_type, COUNT(*) as count, SUM(total_amount) as volume
FROM trades GROUP BY trade_type;
```

#### 系统配置管理
```sql
-- 查看系统配置
SELECT key, value, description FROM system_configs 
WHERE is_public = true;

-- 更新系统配置
UPDATE system_configs 
SET value = 'new_value' 
WHERE key = 'config_key';
```

---

## 🔧 系统维护操作

### 1. 服务重启

#### 重启用户服务
```bash
# 停止当前服务
pkill -f "node.*user-service"

# 重新启动
cd /root/trademe/backend/user-service
npm run dev > /dev/null 2>&1 &
```

#### 重启交易服务
```bash
# 停止当前服务  
pkill -f "uvicorn.*trading-service"

# 重新启动
cd /root/trademe/backend/trading-service
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8001 --log-level info > /dev/null 2>&1 &
```

#### 重启Nginx
```bash
sudo systemctl reload nginx
# 或者
sudo systemctl restart nginx
```

### 2. 数据库维护

#### 数据库备份
```bash
# 创建备份目录
mkdir -p /root/trademe/backups

# 备份SQLite数据库
cp /root/trademe/backend/user-service/prisma/data/trademe.db \
   /root/trademe/backups/trademe_backup_$(date +%Y%m%d_%H%M%S).db
```

#### 数据库优化
```sql
-- 连接数据库
sqlite3 /root/trademe/backend/user-service/prisma/data/trademe.db

-- 清理数据库
VACUUM;

-- 重新生成统计信息
ANALYZE;

-- 检查数据库完整性
PRAGMA integrity_check;
```

### 3. 日志管理

#### 日志轮转设置
```bash
# 创建日志轮转配置
sudo tee /etc/logrotate.d/trademe << EOF
/var/log/nginx/trademe_*.log {
    daily
    missingok
    rotate 30
    compress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload nginx > /dev/null 2>&1
    endscript
}

/root/trademe/backend/user-service/logs/*.log {
    daily
    missingok  
    rotate 30
    compress
    notifempty
    create 644 root root
}
EOF
```

#### 清理旧日志
```bash
# 清理7天前的日志
find /root/trademe/backend/user-service/logs/ -name "*.log" -mtime +7 -delete
find /var/log/nginx/ -name "trademe_*.log.*" -mtime +30 -delete
```

---

## 📊 性能监控

### 1. 系统性能指标

#### 服务器资源监控
```bash
# CPU和内存监控
htop

# 磁盘I/O监控  
iotop

# 网络监控
iftop

# 进程监控
ps aux | grep -E "(node|python|nginx)"
```

#### 数据库性能
```sql
-- 查看数据库大小
SELECT 
  name,
  file_size / (1024 * 1024) as size_mb
FROM (
  SELECT 'main' as name, 
         (SELECT page_count * page_size FROM pragma_page_count(), pragma_page_size()) as file_size
);

-- 查看表行数统计
SELECT 
  name,
  (SELECT COUNT(*) FROM sqlite_master WHERE name = t.name) as row_count
FROM sqlite_master t WHERE type = 'table';
```

### 2. API性能监控

#### 响应时间统计
```bash
# 检查API响应时间
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:3001/health

# 创建curl格式文件
cat > curl-format.txt << EOF
     time_namelookup:  %{time_namelookup}\n
        time_connect:  %{time_connect}\n
     time_appconnect:  %{time_appconnect}\n
    time_pretransfer:  %{time_pretransfer}\n
       time_redirect:  %{time_redirect}\n
  time_starttransfer:  %{time_starttransfer}\n
                     ----------\n
          time_total:  %{time_total}\n
EOF
```

#### 并发测试
```bash  
# 安装Apache Bench
sudo apt-get install apache2-utils

# 并发测试登录API
ab -n 100 -c 10 -p login.json -T application/json \
   http://43.167.252.120/api/v1/auth/login

# 创建测试数据
cat > login.json << EOF
{"email":"demo@trademe.com","password":"Demo123!"}
EOF
```

---

## 🚨 故障排除

### 1. 常见问题诊断

#### 网站无法访问
```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查端口监听
netstat -tlnp | grep :80

# 检查防火墙
sudo ufw status

# 测试本地访问
curl -I http://localhost
```

#### API调用失败  
```bash
# 检查用户服务
curl http://localhost:3001/health

# 检查交易服务  
curl http://localhost:8001/health

# 检查服务进程
ps aux | grep -E "(node|uvicorn)"
```

#### 数据库连接问题
```bash
# 检查数据库文件权限
ls -la /root/trademe/backend/user-service/prisma/data/

# 测试数据库连接
sqlite3 /root/trademe/backend/user-service/prisma/data/trademe.db ".tables"

# 检查Redis连接
redis-cli ping
```

### 2. 错误日志分析

#### 分析用户服务错误
```bash
# 查看最新错误
grep "error" /root/trademe/backend/user-service/logs/combined.log | tail -10

# 分析CORS错误
grep "CORS" /root/trademe/backend/user-service/logs/combined.log

# 分析认证错误
grep -E "(login|auth)" /root/trademe/backend/user-service/logs/combined.log | grep error
```

#### 分析Nginx错误
```bash
# 查看最新错误
tail -20 /var/log/nginx/trademe_error.log

# 分析访问模式
awk '{print $1}' /var/log/nginx/trademe_access.log | sort | uniq -c | sort -nr
```

---

## 🔒 安全管理

### 1. 用户安全

#### 密码策略
- 最小长度: 8位
- 必须包含: 大写字母、小写字母、数字、特殊字符
- 密码加密存储 (bcrypt)

#### 会话管理
```sql
-- 查看活跃会话
SELECT user_id, expires_at, created_at 
FROM user_sessions 
WHERE expires_at > datetime('now');

-- 清理过期会话
DELETE FROM user_sessions 
WHERE expires_at <= datetime('now');
```

### 2. API安全

#### 速率限制配置
```javascript
// 当前配置 (用户服务)
RATE_LIMIT_WINDOW=15  // 15分钟窗口
RATE_LIMIT_MAX=100    // 最多100次请求
```

#### CORS配置管理
```bash
# 查看当前CORS配置
grep ALLOWED_ORIGINS /root/trademe/backend/user-service/.env

# 生产环境建议限制来源
ALLOWED_ORIGINS=http://43.167.252.120
```

### 3. 系统安全

#### 文件权限检查
```bash
# 检查关键文件权限
ls -la /root/trademe/backend/user-service/.env
ls -la /root/trademe/backend/user-service/prisma/data/trademe.db

# 设置安全权限
chmod 600 /root/trademe/backend/user-service/.env
chmod 644 /root/trademe/backend/user-service/prisma/data/trademe.db
```

#### SSL/HTTPS配置 (生产环境)
```bash
# 使用Let's Encrypt申请证书
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

---

## 📋 维护清单

### 每日检查
- [ ] 检查所有服务运行状态
- [ ] 查看错误日志
- [ ] 检查磁盘空间使用
- [ ] 验证网站正常访问

### 每周检查  
- [ ] 数据库备份
- [ ] 清理旧日志文件
- [ ] 更新系统安全补丁
- [ ] 检查用户注册/登录趋势

### 每月检查
- [ ] 系统性能分析
- [ ] 数据库优化 (VACUUM, ANALYZE)
- [ ] 安全审计
- [ ] 备份文件归档

---

## 📞 紧急联系

### 系统故障处理
1. **服务中断**: 立即重启相关服务
2. **数据损坏**: 从最新备份恢复
3. **安全事件**: 暂停服务，分析日志
4. **性能问题**: 检查资源使用，优化配置

### 联系方式
- **技术负责人**: 系统管理员
- **服务器位置**: 腾讯云 (43.167.252.120)
- **备份位置**: `/root/trademe/backups/`

---

**文档更新**: 2025年8月20日  
**版本**: v1.0.0  
**状态**: 生产就绪