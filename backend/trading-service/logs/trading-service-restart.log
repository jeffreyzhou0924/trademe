INFO:     Will watch for changes in these directories: ['/root/trademe/backend/trading-service']
INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
INFO:     Started reloader process [3231193] using WatchFiles
2025-09-03 13:01:25.539 | INFO     | app.ai.core.claude_client:__init__:114 - 使用自定义Claude API端点: https://claude.cloudcdn7.com/api
2025-09-03 13:01:25.560 | INFO     | app.ai.core.claude_client:__init__:118 - Claude客户端初始化成功
2025-09-03 13:01:25.561 | INFO     | app.ai.core.claude_client:_init_proxy_manager:156 - ✅ 代理重试管理器已初始化
2025-09-03 13:01:25.561 | INFO     | app.ai.core.claude_client:__init__:138 - Claude客户端初始化完成 - 模型: claude-sonnet-4-20250514, 启用状态: True
2025-09-03 13:01:26.101 | INFO     | app.services.okx_service:__init__:116 - 🚀 OKX交易服务初始化完成
INFO:app.services.wallet_generator:多链钱包生成器初始化完成
INFO:app.security.crypto_manager:加密管理器初始化完成
✅ 使用logging.yaml配置文件
✅ API验证中间件集成成功
2025-09-03 13:01:26 | uvicorn.error | INFO | Started server process [3231206]
2025-09-03 13:01:26 | uvicorn.error | INFO | Waiting for application startup.
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/auth/register, 字段数: 2
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/auth/login, 字段数: 2
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/trading/orders, 字段数: 5
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/strategies, 字段数: 3
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/ai/chat, 字段数: 3
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/market-data/klines, 字段数: 3
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/backtest, 字段数: 5
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/wallet/transfer, 字段数: 3
2025-09-03 13:01:26 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/data/download, 字段数: 5
✅ 数据库初始化成功
📋 包含的表：用户、策略、回测、交易、API密钥、市场数据、Claude对话、交易心得
📋 管理后台表：管理员、Claude代理池、USDT支付、数据采集
✅ Redis连接成功
🔑 OKX API认证成功，已连接到真实交易接口
🚀 Trading Service 启动成功
📊 环境: development
🏠 Host: 0.0.0.0:8001
2025-09-03 13:01:26 | uvicorn.error | INFO | Application startup complete.
2025-09-03 13:03:39.496 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:03:39.497 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.000s
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:54120', 'GET', '/docs', '1.1', 200)
2025-09-03 13:03:44.502 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:03:44.503 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.001s
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:54122', 'GET', '/health', '1.1', 200)
2025-09-03 13:03:56 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://localhost:8001/api/v1/strategies/", "path": "/api/v1/strategies/", "client_ip": "127.0.***.***.***", "user_agent": "curl/8.5.0", "timestamp": "2025-09-03T05:03:56.591767", "headers": {"host": "localhost:8001", "user-agent": "curl/8.5.0", "accept": "*/*", "authorization": "Bearer "}, "query_params": {}}
2025-09-03 13:03:56 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:03:56 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/strategies/
2025-09-03 13:03:56.592 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:03:56.593 | WARNING  | app.middleware.structured_logging:log_request_end:181 - Client error: 401
2025-09-03 13:03:56 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/strategies/", "status_code": 401, "duration": 1.51, "timestamp": "2025-09-03T05:03:56.593245"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:44512', 'GET', '/api/v1/strategies/', '1.1', 401)
2025-09-03 13:04:06 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://localhost:8001/api/v1/ai/chat", "path": "/api/v1/ai/chat", "client_ip": "127.0.***.***.***", "user_agent": "curl/8.5.0", "timestamp": "2025-09-03T05:04:06.094511", "headers": {"host": "localhost:8001", "user-agent": "curl/8.5.0", "accept": "*/*", "content-type": "application/json", "authorization": "Bearer eyJhbGciOi...9cyDM4", "content-length": "64"}, "body": {"content": "test security validation", "session_type": "strategy"}}
2025-09-03 13:04:06.095 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:04:06.152 | INFO     | app.services.ai_service:chat_completion:173 - 动态上下文优化 - 会话:95d02f2a-b434-4bf3-a7a0-70c73e3fa01e, 窗口:10, 策略:default_fallback
2025-09-03 13:04:06 | app.services.claude_scheduler_service | INFO | Starting account selection with context: SchedulerContext(user_id=6, request_type='chat', model_name=None, session_id='95d02f2a-b434-4bf3-a7a0-70c73e3fa01e', min_quota=Decimal('0.02'), prefer_proxy=False, excluded_accounts=None, priority=100)
2025-09-03 13:04:06 | app.services.claude_scheduler_service | INFO | Query returned 1 raw candidates
2025-09-03 13:04:06 | app.services.claude_scheduler_service | INFO |   - claudetest: status=active, limit=1000.00, usage=0.00, remaining=1000.00
2025-09-03 13:04:06 | app.services.claude_scheduler_service | INFO | Account claudetest suitable check: True
2025-09-03 13:04:06 | app.services.claude_scheduler_service | INFO | Found 1 suitable candidate accounts after filtering
2025-09-03 13:04:06 | app.services.claude_scheduler_service | INFO | Account selection decision: {
  "timestamp": "2025-09-03T05:04:06.159806",
  "selected_account_id": 1,
  "selected_account_name": "claudetest",
  "score": 96.93333333333334,
  "reasons": [
    "success_rate: 100.0%",
    "remaining_quota: $1000.00 (score: 100.0)",
    "response_time: 2315ms (score: 59.7)",
    "last_used_hours: 24.340296354166668 (score: 100.0)"
  ],
  "context": {
    "user_id": 6,
    "request_type": "chat",
    "model_name": null,
    "session_id": "95d02f2a-b434-4bf3-a7a0-70c73e3fa01e",
    "priority": 100
  }
}
2025-09-03 13:04:06 | app.services.claude_scheduler_service | INFO | Selected account: claudetest (ID: 1, Score: 96.93)
--- Logging error ---
Traceback (most recent call last):
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 144, in decrypt_private_key
    combined_data = base64.b64decode(encrypted_private_key.encode('utf-8'))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/base64.py", line 88, in b64decode
    return binascii.a2b_base64(s, strict_mode=validate)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
binascii.Error: Incorrect padding

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'user_id'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'user_id'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 75, in app
    response = await f(request)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/routing.py", line 302, in app
    raw_response = await run_endpoint_function(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
  File "/root/trademe/backend/trading-service/app/api/v1/ai.py", line 49, in chat_with_ai
    response = await unified_proxy_ai_service.chat_completion_with_context(
  File "/root/trademe/backend/trading-service/app/services/simplified_ai_service.py", line 188, in chat_completion_with_context
    return await AIService.chat_completion(**supported_params)
  File "/root/trademe/backend/trading-service/app/services/ai_service.py", line 202, in chat_completion
    api_key = await claude_account_service.get_decrypted_api_key(selected_account.id)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 201, in get_decrypted_api_key
    return self._decrypt_sensitive_data(account.api_key)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 81, in _decrypt_sensitive_data
    return self.crypto_manager.decrypt_private_key(encrypted_data, additional_context)
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 172, in decrypt_private_key
    logger.error(f"私钥解密失败: {e}")
Message: '私钥解密失败: Incorrect padding'
Arguments: ()
2025-09-03 13:04:06 | app.services.claude_account_service | ERROR | Failed to decrypt data for : 私钥解密失败: Incorrect padding
2025-09-03 13:04:06 | app.services.claude_account_service | ERROR | Cannot decrypt API key for account 1: Failed to decrypt sensitive data: 私钥解密失败: Incorrect padding
2025-09-03 13:04:06.169 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.074s
2025-09-03 13:04:06 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/ai/chat", "status_code": 200, "duration": 75.15, "timestamp": "2025-09-03T05:04:06.169631"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:56516', 'POST', '/api/v1/ai/chat', '1.1', 200)
2025-09-03 13:04:12 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://localhost:8001/api/v1/test/malicious", "path": "/api/v1/test/malicious", "client_ip": "127.0.***.***.***", "user_agent": "curl/8.5.0", "timestamp": "2025-09-03T05:04:12.975202", "headers": {"host": "localhost:8001", "user-agent": "curl/8.5.0", "accept": "*/*", "content-type": "application/json", "content-length": "131"}, "body": {"sql_injection": "SELECT * FROM users WHERE id=1 OR 1=1", "xss_attack": "<script>alert(\"XSS\")</script>", "normal_field": "test_data"}}
2025-09-03 13:04:12 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/test/malicious
2025-09-03 13:04:12.976 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:04:12.977 | WARNING  | app.middleware.structured_logging:log_request_end:181 - Client error: 404
2025-09-03 13:04:12 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/test/malicious", "status_code": 404, "duration": 2.54, "timestamp": "2025-09-03T05:04:12.977715"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:56524', 'POST', '/api/v1/test/malicious', '1.1', 404)
2025-09-03 13:05:10.379 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:05:10.380 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.001s
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:53868', 'GET', '/health', '1.1', 200)
2025-09-03 13:05:18 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://localhost:8001/api/v1/ai/chat", "path": "/api/v1/ai/chat", "client_ip": "127.0.***.***.***", "user_agent": "curl/8.5.0", "timestamp": "2025-09-03T05:05:18.387295", "headers": {"host": "localhost:8001", "user-agent": "curl/8.5.0", "accept": "*/*", "content-type": "application/json", "authorization": "Bearer ", "content-length": "64"}, "body": {"content": "测试安全集成效果", "session_type": "strategy"}}
2025-09-03 13:05:18.388 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:05:18.389 | WARNING  | app.middleware.structured_logging:log_request_end:181 - Client error: 401
2025-09-03 13:05:18 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/ai/chat", "status_code": 401, "duration": 2.21, "timestamp": "2025-09-03T05:05:18.389482"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:38736', 'POST', '/api/v1/ai/chat', '1.1', 401)
2025-09-03 13:05:57 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://localhost:8001/api/v1/ai/chat", "path": "/api/v1/ai/chat", "client_ip": "127.0.***.***.***", "user_agent": "curl/8.5.0", "timestamp": "2025-09-03T05:05:57.938374", "headers": {"host": "localhost:8001", "user-agent": "curl/8.5.0", "accept": "*/*", "content-type": "application/json", "authorization": "Bearer eyJhbGciOi...Ded5a4", "content-length": "70"}, "body": {"content": "测试安全集成功能验证", "session_type": "strategy"}}
2025-09-03 13:05:57.939 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:05:57.940 | WARNING  | app.middleware.structured_logging:log_request_end:181 - Client error: 401
2025-09-03 13:05:57 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/ai/chat", "status_code": 401, "duration": 2.24, "timestamp": "2025-09-03T05:05:57.940556"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:39800', 'POST', '/api/v1/ai/chat', '1.1', 401)
2025-09-03 13:06:51 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://localhost:8001/api/v1/ai/chat", "path": "/api/v1/ai/chat", "client_ip": "127.0.***.***.***", "user_agent": "curl/8.5.0", "timestamp": "2025-09-03T05:06:51.436232", "headers": {"host": "localhost:8001", "user-agent": "curl/8.5.0", "accept": "*/*", "content-type": "application/json", "authorization": "Bearer eyJhbGciOi...3-YFQY", "content-length": "71"}, "body": {"content": "验证Phase 1安全集成效果", "session_type": "strategy"}}
2025-09-03 13:06:51.437 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:06:51.440 | WARNING  | app.middleware.structured_logging:log_request_end:181 - Client error: 401
2025-09-03 13:06:51 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/ai/chat", "status_code": 401, "duration": 4.19, "timestamp": "2025-09-03T05:06:51.440395"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:47390', 'POST', '/api/v1/ai/chat', '1.1', 401)
2025-09-03 13:07:49 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://localhost:8001/api/v1/ai/chat", "path": "/api/v1/ai/chat", "client_ip": "127.0.***.***.***", "user_agent": "curl/8.5.0", "timestamp": "2025-09-03T05:07:49.713332", "headers": {"host": "localhost:8001", "user-agent": "curl/8.5.0", "accept": "*/*", "content-type": "application/json", "authorization": "Bearer eyJhbGciOi...V3dhUc", "content-length": "77"}, "body": {"content": "验证Phase 1安全集成最终效果", "session_type": "strategy"}}
2025-09-03 13:07:49.714 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:07:49.719 | INFO     | app.services.ai_service:chat_completion:173 - 动态上下文优化 - 会话:f16a1b0a-7092-4a2c-80f0-2a69755571d8, 窗口:10, 策略:default_fallback
2025-09-03 13:07:49 | app.services.claude_scheduler_service | INFO | Starting account selection with context: SchedulerContext(user_id=6, request_type='chat', model_name=None, session_id='f16a1b0a-7092-4a2c-80f0-2a69755571d8', min_quota=Decimal('0.02'), prefer_proxy=False, excluded_accounts=None, priority=100)
2025-09-03 13:07:49 | app.services.claude_scheduler_service | INFO | Query returned 1 raw candidates
2025-09-03 13:07:49 | app.services.claude_scheduler_service | INFO |   - claudetest: status=active, limit=1000.00, usage=0.00, remaining=1000.00
2025-09-03 13:07:49 | app.services.claude_scheduler_service | INFO | Account claudetest suitable check: True
2025-09-03 13:07:49 | app.services.claude_scheduler_service | INFO | Found 1 suitable candidate accounts after filtering
2025-09-03 13:07:49 | app.services.claude_scheduler_service | INFO | Account selection decision: {
  "timestamp": "2025-09-03T05:07:49.723000",
  "selected_account_id": 1,
  "selected_account_name": "claudetest",
  "score": 96.93333333333334,
  "reasons": [
    "success_rate: 100.0%",
    "remaining_quota: $1000.00 (score: 100.0)",
    "response_time: 2315ms (score: 59.7)",
    "last_used_hours: 24.40239724222222 (score: 100.0)"
  ],
  "context": {
    "user_id": 6,
    "request_type": "chat",
    "model_name": null,
    "session_id": "f16a1b0a-7092-4a2c-80f0-2a69755571d8",
    "priority": 100
  }
}
2025-09-03 13:07:49 | app.services.claude_scheduler_service | INFO | Selected account: claudetest (ID: 1, Score: 96.93)
--- Logging error ---
Traceback (most recent call last):
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 144, in decrypt_private_key
    combined_data = base64.b64decode(encrypted_private_key.encode('utf-8'))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/base64.py", line 88, in b64decode
    return binascii.a2b_base64(s, strict_mode=validate)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
binascii.Error: Incorrect padding

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'user_id'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'user_id'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 75, in app
    response = await f(request)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/routing.py", line 302, in app
    raw_response = await run_endpoint_function(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
  File "/root/trademe/backend/trading-service/app/api/v1/ai.py", line 49, in chat_with_ai
    response = await unified_proxy_ai_service.chat_completion_with_context(
  File "/root/trademe/backend/trading-service/app/services/simplified_ai_service.py", line 188, in chat_completion_with_context
    return await AIService.chat_completion(**supported_params)
  File "/root/trademe/backend/trading-service/app/services/ai_service.py", line 202, in chat_completion
    api_key = await claude_account_service.get_decrypted_api_key(selected_account.id)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 201, in get_decrypted_api_key
    return self._decrypt_sensitive_data(account.api_key)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 81, in _decrypt_sensitive_data
    return self.crypto_manager.decrypt_private_key(encrypted_data, additional_context)
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 172, in decrypt_private_key
    logger.error(f"私钥解密失败: {e}")
Message: '私钥解密失败: Incorrect padding'
Arguments: ()
2025-09-03 13:07:49 | app.services.claude_account_service | ERROR | Failed to decrypt data for : 私钥解密失败: Incorrect padding
2025-09-03 13:07:49 | app.services.claude_account_service | ERROR | Cannot decrypt API key for account 1: Failed to decrypt sensitive data: 私钥解密失败: Incorrect padding
2025-09-03 13:07:49.726 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.012s
2025-09-03 13:07:49 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/ai/chat", "status_code": 200, "duration": 13.84, "timestamp": "2025-09-03T05:07:49.727113"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('127.0.0.1:42172', 'POST', '/api/v1/ai/chat', '1.1', 200)
2025-09-03 13:09:08 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/ai/usage/stats?days=1", "path": "/api/v1/ai/usage/stats", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:08.122906", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "application/json, text/plain, */*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/ai-chat"}, "query_params": {"days": "1"}}
2025-09-03 13:09:08 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:08 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:08 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/ai/usage/stats
2025-09-03 13:09:08.124 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:08.128 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.004s
2025-09-03 13:09:08 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/ai/usage/stats", "status_code": 200, "duration": 6.24, "timestamp": "2025-09-03T05:09:08.129111"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/ai/usage/stats?days=1', '1.0', 200)
2025-09-03 13:09:08 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/ai/sessions?ai_mode=developer", "path": "/api/v1/ai/sessions", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:08.228830", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "application/json, text/plain, */*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/ai-chat"}, "query_params": {"ai_mode": "developer"}}
2025-09-03 13:09:08 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:08 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:08 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/ai/sessions
2025-09-03 13:09:08.230 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:08.235 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.005s
2025-09-03 13:09:08 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/ai/sessions", "status_code": 200, "duration": 6.78, "timestamp": "2025-09-03T05:09:08.235584"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/ai/sessions?ai_mode=developer', '1.0', 200)
2025-09-03 13:09:10 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/ai/chat/history?session_id=00d03dd6-5742-4cdf-8f49-338ae5b990fc&limit=20", "path": "/api/v1/ai/chat/history", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:10.073024", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "application/json, text/plain, */*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/ai-chat"}, "query_params": {"session_id": "00d03dd6-5742-4cdf-8f49-338ae5b990fc", "limit": "20"}}
2025-09-03 13:09:10 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:10 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:10 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/ai/chat/history
2025-09-03 13:09:10.075 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:10.080 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.005s
2025-09-03 13:09:10 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/ai/chat/history", "status_code": 200, "duration": 7.6, "timestamp": "2025-09-03T05:09:10.080597"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/ai/chat/history?session_id=00d03dd6-5742-4cdf-8f49-338ae5b990fc&limit=20', '1.0', 200)
2025-09-03 13:09:11 | uvicorn.error | INFO | 167.234.***.***.***:0 - "WebSocket /ws/realtime" [accepted]
🔌 WebSocket连接请求: conn_1756876151527
2025-09-03 13:09:11 | uvicorn.error | INFO | connection open
2025-09-03 13:09:15.431 | INFO     | app.services.dynamic_context_manager:calculate_optimal_context_window:95 - 动态上下文计算完成 - 会话:00d03dd6-5742-4cdf-8f49-338ae5b990fc, 窗口:12, 消息数:3
2025-09-03 13:09:15.435 | INFO     | app.services.dynamic_context_manager:calculate_optimal_context_window:95 - 动态上下文计算完成 - 会话:00d03dd6-5742-4cdf-8f49-338ae5b990fc, 窗口:12, 消息数:3
2025-09-03 13:09:15.436 | INFO     | app.services.ai_service:chat_completion:173 - 动态上下文优化 - 会话:00d03dd6-5742-4cdf-8f49-338ae5b990fc, 窗口:12, 策略:dynamic_optimization
🤖 开始调用真实Claude AI服务，用户: 6, 内容: test...
📡 调用AIService.chat_completion...
2025-09-03 13:09:15 | app.services.claude_scheduler_service | INFO | Starting account selection with context: SchedulerContext(user_id=6, request_type='chat', model_name=None, session_id='00d03dd6-5742-4cdf-8f49-338ae5b990fc', min_quota=Decimal('0.02'), prefer_proxy=False, excluded_accounts=None, priority=100)
2025-09-03 13:09:15 | app.services.claude_scheduler_service | INFO | Query returned 1 raw candidates
2025-09-03 13:09:15 | app.services.claude_scheduler_service | INFO |   - claudetest: status=active, limit=1000.00, usage=0.00, remaining=1000.00
2025-09-03 13:09:15 | app.services.claude_scheduler_service | INFO | Account claudetest suitable check: True
2025-09-03 13:09:15 | app.services.claude_scheduler_service | INFO | Found 1 suitable candidate accounts after filtering
2025-09-03 13:09:15 | app.services.claude_scheduler_service | INFO | Account selection decision: {
  "timestamp": "2025-09-03T05:09:15.439356",
  "selected_account_id": 1,
  "selected_account_name": "claudetest",
  "score": 96.93333333333334,
  "reasons": [
    "success_rate: 100.0%",
    "remaining_quota: $1000.00 (score: 100.0)",
    "response_time: 2315ms (score: 59.7)",
    "last_used_hours: 24.4262073425 (score: 100.0)"
  ],
  "context": {
    "user_id": 6,
    "request_type": "chat",
    "model_name": null,
    "session_id": "00d03dd6-5742-4cdf-8f49-338ae5b990fc",
    "priority": 100
  }
}
2025-09-03 13:09:15 | app.services.claude_scheduler_service | INFO | Selected account: claudetest (ID: 1, Score: 96.93)
--- Logging error ---
Traceback (most recent call last):
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 144, in decrypt_private_key
    combined_data = base64.b64decode(encrypted_private_key.encode('utf-8'))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/base64.py", line 88, in b64decode
    return binascii.a2b_base64(s, strict_mode=validate)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
binascii.Error: Incorrect padding

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'user_id'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'user_id'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  [Previous line repeated 1 more time]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 97, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 95, in app
    await func(session)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/routing.py", line 384, in app
    await dependant.call(**solved_result.values)
  File "/root/trademe/backend/trading-service/app/main.py", line 561, in websocket_realtime_endpoint
    result = await AIService.chat_completion(
  File "/root/trademe/backend/trading-service/app/services/ai_service.py", line 202, in chat_completion
    api_key = await claude_account_service.get_decrypted_api_key(selected_account.id)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 201, in get_decrypted_api_key
    return self._decrypt_sensitive_data(account.api_key)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 81, in _decrypt_sensitive_data
    return self.crypto_manager.decrypt_private_key(encrypted_data, additional_context)
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 172, in decrypt_private_key
    logger.error(f"私钥解密失败: {e}")
Message: '私钥解密失败: Incorrect padding'
Arguments: ()
2025-09-03 13:09:15 | app.services.claude_account_service | ERROR | Failed to decrypt data for : 私钥解密失败: Incorrect padding
2025-09-03 13:09:15 | app.services.claude_account_service | ERROR | Cannot decrypt API key for account 1: Failed to decrypt sensitive data: 私钥解密失败: Incorrect padding
📨 AI服务返回结果: {"content": "Claude\u8d26\u53f7\u914d\u7f6e\u9519\u8bef\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458", "session_id": "00d03dd6-5742-4cdf-8f49-338ae5b990fc", "tokens_used": 0, "model": "claude-error", "success": false, "requires_strategy_generation": false}
❌ AI服务失败: Claude账号配置错误，请联系管理员
WebSocket消息处理错误: (1001, '')
❌ WebSocket连接已断开: conn_1756876151527 (用户: 6)
2025-09-03 13:09:17 | uvicorn.error | INFO | connection closed
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/accounts", "path": "/api/v1/admin/claude/accounts", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:21.443402", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:21 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:21 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/accounts
2025-09-03 13:09:21.444 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/proxies", "path": "/api/v1/admin/claude/proxies", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:21.444936", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:21 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:21 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/proxies
2025-09-03 13:09:21.447 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:21.454 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.010s
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/accounts", "status_code": 200, "duration": 11.87, "timestamp": "2025-09-03T05:09:21.455244"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/accounts', '1.0', 200)
2025-09-03 13:09:21.456 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.010s
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/proxies", "status_code": 200, "duration": 12.3, "timestamp": "2025-09-03T05:09:21.457216"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/proxies', '1.0', 200)
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/anomaly-detection", "path": "/api/v1/admin/claude/anomaly-detection", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:21.547941", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:21 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:21 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/anomaly-detection
2025-09-03 13:09:21.549 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/users/", "path": "/api/v1/admin/users/", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:21.554065", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:21 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:21 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/users/
2025-09-03 13:09:21.555 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/usage-stats?days=30", "path": "/api/v1/admin/claude/usage-stats", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:21.559861", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {"days": "30"}}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:21 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:21 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/usage-stats
2025-09-03 13:09:21.561 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:21.565 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.017s
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/anomaly-detection", "status_code": 200, "duration": 18.16, "timestamp": "2025-09-03T05:09:21.566069"}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/users-detailed-stats", "path": "/api/v1/admin/claude/users-detailed-stats", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:21.566438", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:21 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:21 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/users-detailed-stats
2025-09-03 13:09:21.567 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/anomaly-detection', '1.0', 200)
2025-09-03 13:09:21.572 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.017s
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/users/", "status_code": 200, "duration": 19.82, "timestamp": "2025-09-03T05:09:21.573868"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/users/', '1.0', 200)
2025-09-03 13:09:21 | app.api.v1.admin.claude | ERROR | 获取用户详细统计失败: (sqlite3.OperationalError) no such column: cl.tokens_input
[SQL: 
            SELECT 
                u.id as user_id,
                u.username,
                u.email,
                u.membership_level,
                u.is_active,
                u.last_login_at,
                COALESCE(SUM(cl.tokens_input + cl.tokens_output), 0) as total_tokens,
                COALESCE(COUNT(cl.id), 0) as total_requests,
                COALESCE(SUM(cl.api_cost), 0.0) as total_cost,
                MAX(cl.request_date) as last_usage_date
            FROM users u
            LEFT JOIN claude_usage_logs cl ON u.id = cl.user_id
            WHERE u.id IS NOT NULL
            GROUP BY u.id, u.username, u.email, u.membership_level, u.is_active, u.last_login_at
            ORDER BY total_cost DESC, total_requests DESC
            LIMIT 50
        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-09-03 13:09:21.578 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.011s
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/users-detailed-stats", "status_code": 200, "duration": 12.17, "timestamp": "2025-09-03T05:09:21.578589"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/users-detailed-stats', '1.0', 200)
2025-09-03 13:09:21.583 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.022s
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/usage-stats", "status_code": 200, "duration": 23.78, "timestamp": "2025-09-03T05:09:21.583617"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/usage-stats?days=30', '1.0', 200)
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/anthropic-accounts/", "path": "/api/v1/anthropic-accounts/", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:21.725773", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:21 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:21 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/anthropic-accounts/
2025-09-03 13:09:21.726 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:21 | app.api.v1.anthropic_accounts | INFO | 📋 Listed 0 Anthropic Setup Token accounts
2025-09-03 13:09:21.734 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.007s
2025-09-03 13:09:21 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/anthropic-accounts/", "status_code": 200, "duration": 8.64, "timestamp": "2025-09-03T05:09:21.734391"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/anthropic-accounts/', '1.0', 200)
2025-09-03 13:09:25 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "DELETE", "url": "http://43.167.***.***.***/api/v1/admin/claude/accounts/1", "path": "/api/v1/admin/claude/accounts/1", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:25.559706", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "origin": "http://43.167.***.***.***", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:25 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:25 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/accounts/1
2025-09-03 13:09:25.561 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:25.570 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.010s
2025-09-03 13:09:25 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "DELETE", "path": "/api/v1/admin/claude/accounts/1", "status_code": 200, "duration": 11.39, "timestamp": "2025-09-03T05:09:25.571075"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'DELETE', '/api/v1/admin/claude/accounts/1', '1.0', 200)
2025-09-03 13:09:26 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/accounts", "path": "/api/v1/admin/claude/accounts", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:26.667360", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:26 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:26 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:26 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/accounts
2025-09-03 13:09:26.668 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:26.672 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.004s
2025-09-03 13:09:26 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/accounts", "status_code": 200, "duration": 5.61, "timestamp": "2025-09-03T05:09:26.672923"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/accounts', '1.0', 200)
2025-09-03 13:09:44 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://43.167.***.***.***/api/v1/admin/claude/accounts", "path": "/api/v1/admin/claude/accounts", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:44.610243", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "content-length": "208", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "content-type": "application/json", "origin": "http://43.167.***.***.***", "referer": "http://43.167.***.***.***/admin/claude"}, "body": {"account_name": "claudetest", "api_key": "***", "daily_limit": 100, "proxy_base_url": "https://claude.cloudcdn7.com/api", "proxy_type": "proxy_service"}}
2025-09-03 13:09:44 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:44 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/accounts
2025-09-03 13:09:44.611 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:44.625 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.014s
2025-09-03 13:09:44 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/admin/claude/accounts", "status_code": 200, "duration": 15.63, "timestamp": "2025-09-03T05:09:44.625848"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'POST', '/api/v1/admin/claude/accounts', '1.0', 200)
2025-09-03 13:09:46 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/accounts", "path": "/api/v1/admin/claude/accounts", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:46.007011", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:46 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:46 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:46 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/accounts
2025-09-03 13:09:46.008 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:46.012 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.004s
2025-09-03 13:09:46 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/accounts", "status_code": 200, "duration": 5.25, "timestamp": "2025-09-03T05:09:46.012229"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/accounts', '1.0', 200)
2025-09-03 13:09:47 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "POST", "url": "http://43.167.***.***.***/api/v1/admin/claude/accounts/1/test", "path": "/api/v1/admin/claude/accounts/1/test", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:47.237964", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "content-length": "0", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "origin": "http://43.167.***.***.***", "referer": "http://43.167.***.***.***/admin/claude"}}
2025-09-03 13:09:47 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:47 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/accounts/1/test
2025-09-03 13:09:47.239 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:48.945 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 1.707s
2025-09-03 13:09:48 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "POST", "path": "/api/v1/admin/claude/accounts/1/test", "status_code": 200, "duration": 1708.2, "timestamp": "2025-09-03T05:09:48.946139"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'POST', '/api/v1/admin/claude/accounts/1/test', '1.0', 200)
2025-09-03 13:09:50 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/claude/accounts", "path": "/api/v1/admin/claude/accounts", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:50.219561", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin/claude"}, "query_params": {}}
2025-09-03 13:09:50 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:50 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:50 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/claude/accounts
2025-09-03 13:09:50.220 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:50.224 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.004s
2025-09-03 13:09:50 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/claude/accounts", "status_code": 200, "duration": 5.52, "timestamp": "2025-09-03T05:09:50.225049"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/claude/accounts', '1.0', 200)
2025-09-03 13:09:57 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/stats/system", "path": "/api/v1/admin/stats/system", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:57.450233", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin"}, "query_params": {}}
2025-09-03 13:09:57 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:57 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:57 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/stats/system
2025-09-03 13:09:57.451 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:57 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/admin/users?limit=5", "path": "/api/v1/admin/users", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:09:57.458689", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "*/*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/admin"}, "query_params": {"limit": "5"}}
2025-09-03 13:09:57 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:09:57 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:09:57 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/admin/users
2025-09-03 13:09:57.459 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:09:57.463 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.012s
2025-09-03 13:09:57 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/stats/system", "status_code": 200, "duration": 13.4, "timestamp": "2025-09-03T05:09:57.463605"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/stats/system', '1.0', 200)
2025-09-03 13:09:57.465 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.006s
2025-09-03 13:09:57 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/admin/users", "status_code": 200, "duration": 7.43, "timestamp": "2025-09-03T05:09:57.466097"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/admin/users?limit=5', '1.0', 200)
2025-09-03 13:10:04 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/ai/sessions?ai_mode=developer", "path": "/api/v1/ai/sessions", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:10:04.287288", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "application/json, text/plain, */*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/ai-chat"}, "query_params": {"ai_mode": "developer"}}
2025-09-03 13:10:04 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:10:04 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:10:04 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/ai/sessions
2025-09-03 13:10:04.288 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:10:04.291 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.003s
2025-09-03 13:10:04 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/ai/sessions", "status_code": 200, "duration": 4.53, "timestamp": "2025-09-03T05:10:04.291787"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/ai/sessions?ai_mode=developer', '1.0', 200)
2025-09-03 13:10:04 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/ai/usage/stats?days=1", "path": "/api/v1/ai/usage/stats", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:10:04.294144", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "application/json, text/plain, */*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/ai-chat"}, "query_params": {"days": "1"}}
2025-09-03 13:10:04 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:10:04 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:10:04 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/ai/usage/stats
2025-09-03 13:10:04.295 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:10:04.298 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.003s
2025-09-03 13:10:04 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/ai/usage/stats", "status_code": 200, "duration": 4.11, "timestamp": "2025-09-03T05:10:04.298237"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/ai/usage/stats?days=1', '1.0', 200)
2025-09-03 13:10:05 | app.middleware.api_validation_middleware | INFO | API请求: {"method": "GET", "url": "http://43.167.***.***.***/api/v1/ai/chat/history?session_id=00d03dd6-5742-4cdf-8f49-338ae5b990fc&limit=20", "path": "/api/v1/ai/chat/history", "client_ip": "167.234.***.***.***", "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "timestamp": "2025-09-03T05:10:05.462116", "headers": {"host": "43.167.***.***.***", "x-real-ip": "167.234.***.***.***", "x-forwarded-for": "167.234.***.***.***", "x-forwarded-proto": "http", "connection": "close", "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.***.***.*** Safari/537.36", "accept": "application/json, text/plain, */*", "accept-encoding": "gzip, deflate", "accept-language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7", "authorization": "Bearer eyJhbGciOi...jfgiYc", "referer": "http://43.167.***.***.***/ai-chat"}, "query_params": {"session_id": "00d03dd6-5742-4cdf-8f49-338ae5b990fc", "limit": "20"}}
2025-09-03 13:10:05 | app.middleware.api_validation_middleware | ERROR | 安全检查失败: name 're' is not defined
2025-09-03 13:10:05 | app.services.integrated_cache_manager | WARNING | 缓存管理器尚未初始化
2025-09-03 13:10:05 | app.services.api_validation_service | WARNING | 端点验证配置不存在: /api/v1/ai/chat/history
2025-09-03 13:10:05.463 | INFO     | app.middleware.structured_logging:log_request_start:139 - Request started
2025-09-03 13:10:05.466 | INFO     | app.middleware.structured_logging:log_request_end:181 - Request completed in 0.004s
2025-09-03 13:10:05 | app.middleware.api_validation_middleware | INFO | API响应: {"method": "GET", "path": "/api/v1/ai/chat/history", "status_code": 200, "duration": 5.04, "timestamp": "2025-09-03T05:10:05.467124"}
--- Logging error ---
Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'duration'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'duration'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    await response(scope, wrapped_receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 214, in __call__
    await send(
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 161, in _send
    await send(message)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 476, in send
    self.access_logger.info(
Message: '%s - "%s %s HTTP/%s" %d'
Arguments: ('167.234.211.253:0', 'GET', '/api/v1/ai/chat/history?session_id=00d03dd6-5742-4cdf-8f49-338ae5b990fc&limit=20', '1.0', 200)
2025-09-03 13:10:06 | uvicorn.error | INFO | 167.234.***.***.***:0 - "WebSocket /ws/realtime" [accepted]
🔌 WebSocket连接请求: conn_1756876206958
2025-09-03 13:10:06 | uvicorn.error | INFO | connection open
2025-09-03 13:10:09.902 | INFO     | app.services.dynamic_context_manager:calculate_optimal_context_window:95 - 动态上下文计算完成 - 会话:00d03dd6-5742-4cdf-8f49-338ae5b990fc, 窗口:12, 消息数:3
2025-09-03 13:10:09.906 | INFO     | app.services.dynamic_context_manager:calculate_optimal_context_window:95 - 动态上下文计算完成 - 会话:00d03dd6-5742-4cdf-8f49-338ae5b990fc, 窗口:12, 消息数:3
2025-09-03 13:10:09.906 | INFO     | app.services.ai_service:chat_completion:173 - 动态上下文优化 - 会话:00d03dd6-5742-4cdf-8f49-338ae5b990fc, 窗口:12, 策略:dynamic_optimization
🤖 开始调用真实Claude AI服务，用户: 6, 内容: test...
📡 调用AIService.chat_completion...
2025-09-03 13:10:09 | app.services.claude_scheduler_service | INFO | Starting account selection with context: SchedulerContext(user_id=6, request_type='chat', model_name=None, session_id='00d03dd6-5742-4cdf-8f49-338ae5b990fc', min_quota=Decimal('0.02'), prefer_proxy=False, excluded_accounts=None, priority=100)
2025-09-03 13:10:09 | app.services.claude_scheduler_service | INFO | Using sticky session account: 1
--- Logging error ---
Traceback (most recent call last):
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 144, in decrypt_private_key
    combined_data = base64.b64decode(encrypted_private_key.encode('utf-8'))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/base64.py", line 88, in b64decode
    return binascii.a2b_base64(s, strict_mode=validate)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
binascii.Error: Incorrect padding

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'user_id'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'user_id'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  [Previous line repeated 1 more time]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 97, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 95, in app
    await func(session)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/routing.py", line 384, in app
    await dependant.call(**solved_result.values)
  File "/root/trademe/backend/trading-service/app/main.py", line 561, in websocket_realtime_endpoint
    result = await AIService.chat_completion(
  File "/root/trademe/backend/trading-service/app/services/ai_service.py", line 202, in chat_completion
    api_key = await claude_account_service.get_decrypted_api_key(selected_account.id)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 201, in get_decrypted_api_key
    return self._decrypt_sensitive_data(account.api_key)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 81, in _decrypt_sensitive_data
    return self.crypto_manager.decrypt_private_key(encrypted_data, additional_context)
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 172, in decrypt_private_key
    logger.error(f"私钥解密失败: {e}")
Message: '私钥解密失败: Incorrect padding'
Arguments: ()
2025-09-03 13:10:09 | app.services.claude_account_service | ERROR | Failed to decrypt data for : 私钥解密失败: Incorrect padding
2025-09-03 13:10:09 | app.services.claude_account_service | ERROR | Cannot decrypt API key for account 1: Failed to decrypt sensitive data: 私钥解密失败: Incorrect padding
📨 AI服务返回结果: {"content": "Claude\u8d26\u53f7\u914d\u7f6e\u9519\u8bef\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458", "session_id": "00d03dd6-5742-4cdf-8f49-338ae5b990fc", "tokens_used": 0, "model": "claude-error", "success": false, "requires_strategy_generation": false}
❌ AI服务失败: Claude账号配置错误，请联系管理员
2025-09-03 13:10:25 | uvicorn.error | INFO | 167.234.***.***.***:0 - "WebSocket /ws/realtime" [accepted]
🔌 WebSocket连接请求: conn_1756876225527
2025-09-03 13:10:25 | uvicorn.error | INFO | connection open
2025-09-03 13:10:26.051 | INFO     | app.services.ai_service:chat_completion:173 - 动态上下文优化 - 会话:proxy-test-session, 窗口:10, 策略:default_fallback
🤖 开始调用真实Claude AI服务，用户: 6, 内容: 简单回答：1+1等于几？...
📡 调用AIService.chat_completion...
2025-09-03 13:10:26 | app.services.claude_scheduler_service | INFO | Starting account selection with context: SchedulerContext(user_id=6, request_type='chat', model_name=None, session_id='proxy-test-session', min_quota=Decimal('0.02'), prefer_proxy=False, excluded_accounts=None, priority=100)
2025-09-03 13:10:26 | app.services.claude_scheduler_service | INFO | Query returned 1 raw candidates
2025-09-03 13:10:26 | app.services.claude_scheduler_service | INFO |   - claudetest: status=active, limit=100.00, usage=0.00, remaining=100.00
2025-09-03 13:10:26 | app.services.claude_scheduler_service | INFO | Account claudetest suitable check: True
2025-09-03 13:10:26 | app.services.claude_scheduler_service | INFO | Found 1 suitable candidate accounts after filtering
2025-09-03 13:10:26 | app.services.claude_scheduler_service | INFO | Account selection decision: {
  "timestamp": "2025-09-03T05:10:26.055432",
  "selected_account_id": 1,
  "selected_account_name": "claudetest",
  "score": 89.70230343444445,
  "reasons": [
    "success_rate: 100.0%",
    "remaining_quota: $100.00 (score: 100.0)",
    "response_time: 1694ms (score: 73.5)",
    "last_used_hours: 0.0044850505555555555 (score: 0.1)"
  ],
  "context": {
    "user_id": 6,
    "request_type": "chat",
    "model_name": null,
    "session_id": "proxy-test-session",
    "priority": 100
  }
}
2025-09-03 13:10:26 | app.services.claude_scheduler_service | INFO | Selected account: claudetest (ID: 1, Score: 89.70)
--- Logging error ---
Traceback (most recent call last):
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 144, in decrypt_private_key
    combined_data = base64.b64decode(encrypted_private_key.encode('utf-8'))
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/base64.py", line 88, in b64decode
    return binascii.a2b_base64(s, strict_mode=validate)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
binascii.Error: Incorrect padding

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/__init__.py", line 464, in format
    return self._format(record)
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 460, in _format
    return self._fmt % values
           ~~~~~~~~~~^~~~~~~~
KeyError: 'user_id'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.12/logging/handlers.py", line 73, in emit
    if self.shouldRollover(record):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/handlers.py", line 196, in shouldRollover
    msg = "%s\n" % self.format(record)
                   ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 706, in format
    s = self.formatMessage(record)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 675, in formatMessage
    return self._style.format(record)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/logging/__init__.py", line 466, in format
    raise ValueError('Formatting field not found in record: %s' % e)
ValueError: Formatting field not found in record: 'user_id'
Call stack:
  File "<string>", line 1, in <module>
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 122, in spawn_main
    exitcode = _main(fd, parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/spawn.py", line 135, in _main
    return self._bootstrap(parent_sentinel)
  File "/usr/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/server.py", line 67, in run
    return asyncio.run(self.serve(sockets=sockets))
  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  [Previous line repeated 1 more time]
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 97, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/starlette/routing.py", line 95, in app
    await func(session)
  File "/root/trademe/backend/trading-service/venv/lib/python3.12/site-packages/fastapi/routing.py", line 384, in app
    await dependant.call(**solved_result.values)
  File "/root/trademe/backend/trading-service/app/main.py", line 561, in websocket_realtime_endpoint
    result = await AIService.chat_completion(
  File "/root/trademe/backend/trading-service/app/services/ai_service.py", line 202, in chat_completion
    api_key = await claude_account_service.get_decrypted_api_key(selected_account.id)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 201, in get_decrypted_api_key
    return self._decrypt_sensitive_data(account.api_key)
  File "/root/trademe/backend/trading-service/app/services/claude_account_service.py", line 81, in _decrypt_sensitive_data
    return self.crypto_manager.decrypt_private_key(encrypted_data, additional_context)
  File "/root/trademe/backend/trading-service/app/security/crypto_manager.py", line 172, in decrypt_private_key
    logger.error(f"私钥解密失败: {e}")
Message: '私钥解密失败: Incorrect padding'
Arguments: ()
2025-09-03 13:10:26 | app.services.claude_account_service | ERROR | Failed to decrypt data for : 私钥解密失败: Incorrect padding
2025-09-03 13:10:26 | app.services.claude_account_service | ERROR | Cannot decrypt API key for account 1: Failed to decrypt sensitive data: 私钥解密失败: Incorrect padding
📨 AI服务返回结果: {"content": "Claude\u8d26\u53f7\u914d\u7f6e\u9519\u8bef\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458", "session_id": "proxy-test-session", "tokens_used": 0, "model": "claude-error", "success": false, "requires_strategy_generation": false}
❌ AI服务失败: Claude账号配置错误，请联系管理员
WebSocket消息处理错误: (<CloseCode.NO_STATUS_RCVD: 1005>, '')
❌ WebSocket连接已断开: conn_1756876225527 (用户: 6)
2025-09-03 13:10:26 | uvicorn.error | INFO | connection closed
WARNING:  WatchFiles detected changes in 'app/services/claude_account_service.py'. Reloading...
2025-09-03 13:11:57 | uvicorn.error | INFO | Shutting down
WebSocket消息处理错误: (1012, None)
❌ WebSocket连接已断开: conn_1756876206958 (用户: 6)
2025-09-03 13:11:57 | uvicorn.error | INFO | connection closed
2025-09-03 13:11:57 | uvicorn.error | INFO | Waiting for application shutdown.
✅ 数据库连接已关闭
✅ Redis连接已关闭
👋 Trading Service 已关闭
2025-09-03 13:11:57 | uvicorn.error | INFO | Application shutdown complete.
2025-09-03 13:11:57 | uvicorn.error | INFO | Finished server process [3231206]
2025-09-03 13:12:00.493 | INFO     | app.ai.core.claude_client:__init__:114 - 使用自定义Claude API端点: https://claude.cloudcdn7.com/api
2025-09-03 13:12:00.515 | INFO     | app.ai.core.claude_client:__init__:118 - Claude客户端初始化成功
2025-09-03 13:12:00.515 | INFO     | app.ai.core.claude_client:_init_proxy_manager:156 - ✅ 代理重试管理器已初始化
2025-09-03 13:12:00.515 | INFO     | app.ai.core.claude_client:__init__:138 - Claude客户端初始化完成 - 模型: claude-sonnet-4-20250514, 启用状态: True
2025-09-03 13:12:01.105 | INFO     | app.services.okx_service:__init__:116 - 🚀 OKX交易服务初始化完成
INFO:app.services.wallet_generator:多链钱包生成器初始化完成
INFO:app.security.crypto_manager:加密管理器初始化完成
✅ 使用logging.yaml配置文件
✅ API验证中间件集成成功
2025-09-03 13:12:01 | uvicorn.error | INFO | Started server process [3235412]
2025-09-03 13:12:01 | uvicorn.error | INFO | Waiting for application startup.
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/auth/register, 字段数: 2
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/auth/login, 字段数: 2
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/trading/orders, 字段数: 5
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/strategies, 字段数: 3
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/ai/chat, 字段数: 3
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/market-data/klines, 字段数: 3
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/backtest, 字段数: 5
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/wallet/transfer, 字段数: 3
2025-09-03 13:12:01 | app.services.api_validation_service | INFO | 注册端点验证配置: /api/v1/data/download, 字段数: 5
✅ 数据库初始化成功
📋 包含的表：用户、策略、回测、交易、API密钥、市场数据、Claude对话、交易心得
📋 管理后台表：管理员、Claude代理池、USDT支付、数据采集
✅ Redis连接成功
🔑 OKX API认证成功，已连接到真实交易接口
🚀 Trading Service 启动成功
📊 环境: development
🏠 Host: 0.0.0.0:8001
2025-09-03 13:12:01 | uvicorn.error | INFO | Application startup complete.
2025-09-03 13:12:01 | uvicorn.error | INFO | 167.234.***.***.***:0 - "WebSocket /ws/realtime" [accepted]
🔌 WebSocket连接请求: conn_1756876321794
2025-09-03 13:12:01 | uvicorn.error | INFO | connection open
2025-09-03 13:12:04 | uvicorn.error | INFO | Shutting down
WebSocket消息处理错误: (1012, None)
❌ WebSocket连接已断开: conn_1756876321794 (用户: 6)
2025-09-03 13:12:04 | uvicorn.error | INFO | connection closed
2025-09-03 13:12:04 | uvicorn.error | INFO | Waiting for application shutdown.
✅ 数据库连接已关闭
✅ Redis连接已关闭
👋 Trading Service 已关闭
2025-09-03 13:12:04 | uvicorn.error | INFO | Application shutdown complete.
2025-09-03 13:12:04 | uvicorn.error | INFO | Finished server process [3235412]
INFO:     Stopping reloader process [3231193]
